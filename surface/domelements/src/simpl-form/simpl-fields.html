<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<script src="jquery.dropdown.js"></script>
<link rel="import" type="css" href="bootstrap-datetimepicker-standalone.css" />
<link rel="import" type="css" href="bootstrap-datetimepicker.css" />
<link rel="import" href="../simpl-crud/simpl-crud-shared-styles.html">
<link rel="import" href="form-behavior.html">
<script>
	FieldBehavior = {
		properties: {
			readonly: {
				value: false,
				type: Boolean
			},
			autofocus: {
				value: false,
				type: Boolean
			},
			disabled: {
				value: false,
				type: Boolean
			},
			label: {
				value: null,
				type: String
			},
			name: {
				value: null,
				type: String
			},
			value: {
				type: String
			},
			defaultValue: {
				value: null,
				type: String
			},
			editValue: {
				value: null,
				type: String
			}
		},
		created: function() {
			this._iid = getShortId();
		},

		attached: function() {
			this.isDomReady = true;
		},
		detached: function() {},
		setForm: function( form ) {
			this.form = form;
			this.convertNullToEmpty = form._form.xf_string_null_in_empty===true;
		},
		getPack:function(){
      if( this.form == null) return null;
			var pack = this.form.pack;
			return pack;
		},
		setValue: function( v ) {
			this.value = v;
		},
		getValue: function() {
			return this.value;
		},
		observers: [
			'disabledChanged(disabled)'
		],
		getForm:function(){
			return this.form;
		},
		getSimpleEntityName: function( entity ) {
			if ( entity.indexOf( ':' ) >= 0 ) {
				return entity.split( ':' )[ 1 ];
			}
			return entity;
		},
		disabledChanged: function( event ) {
			this.alwaysFloatLabel = this.disabled;
		},
		_focusBlurHandler: function( event ) {
			var target = event.path ? event.path[ 0 ] : event.target;
			if ( target === this ) {
				var focused = event.type === 'focus';
				this._setFocused( focused );
			} else if ( !this.shadowRoot ) {
				if ( false /*this.hasDate*/ ) {
					event.stopPropagation();
					this.fire( event.type, {
						sourceEvent: event
					}, {
						node: this,
						bubbles: event.bubbles,
						cancelable: event.cancelable
					} );
				}
			}
		},
		checkConstraints: function() {
			var c = this.getAttribute( "data-constraints" );
			if ( c == null || c.length == 0 ) return;
			var elements = [ this ];
			regula.bind( {
				elements: elements
			} );
			this.async( function() {
				var errorList = regula.validate( {
					elements: elements
				} );
				this.setInvalid( errorList.length > 0 );
				if ( errorList.length > 0 ) {
					this.setErrorMessage( errorList[ 0 ].message );
				}else{
					this.setErrorMessage( null );
				}
			} );
		},
		setErrorMessage: function( message ) {
			this.errorMessage = message;
		},
		setInvalid: function( b ) {
			this.invalid = b;
		}
	};

</script>

<dom-module id="html-echo">
	<style>
		:host {
		}
  </style>
	<template><content></content></template>
	<script>
		Polymer( {
			is: 'html-echo',
			behaviors: [
				FieldBehavior
			],
			properties: {
				html: {
					observer:"htmlChanged",
					type: String
				}
			},
			htmlChanged: function() {
				Polymer.dom(this).innerHTML = this.html;
			}
		} );

	</script>
</dom-module>

<!--PAPERFIELDS-->
<dom-module id="input-field" attributes="min max maxlength pattern step" layout horizontal center>
	<style>
		:host {
			--paper-input-container: {
					padding: 0px;
			};
		}
		:host #input.compact {
			padding: 0px !important;
			margin: 0px;
		}

		:host #label {
			padding: 0 !important;
			font-size: 14px;
			font-weight: normal;
		}
		:host #input {
			font-size: 14px;
			font-weight: normal;
		}
		:host.ie  #input {
			height:24px;
		}
		:host.ie .compact{
			min-width:120px;
			display:block;
		}

	</style>
	<template>
		<paper-input-container id="decorator" no-label-float="[[noLabelFloat]]" always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]" auto-validate$="[[autoValidate]]" disabled$="[[disabled]]" invalid="[[invalid]]">

			<label id="label" hidden$="[[!label]]">[[label]]</label>
			<paper-tooltip for="" position="bottom" xffset="0">[[help]]</paper-tooltip>

			<input is="iron-input" id="input"  class="form-control"
				aria-labelledby$="[[_ariaLabelledBy]]"
				aria-describedby$="[[_ariaDescribedBy]]"
				disabled$="[[disabled]]"
				bind-value="{{editValue}}"
				invalid="{{invalid}}"
				prevent-invalid-input="[[preventInvalidInput]]"
				allowed-pattern="[[allowedPattern]]"
				validator="[[validator]]"
				type$="[[type]]"
				pattern$="[[pattern]]"
				maxlength$="[[maxlength]]"
				required$="[[required]]"
				autocomplete$="[[autocomplete]]"
				autofocus$="[[autofocus]]"
				inputmode$="[[inputmode]]"
				minlength$="[[minlength]]"
				min$="[[min]]"
				max$="[[max]]"
				step$="[[step]]"
				name$="[[name]]"
				placeholder$="[[placeholder]]"
				readonly$="[[readonly]]"
				list$="[[list]]"
				size$="[[size]]"
				autocapitalize$="[[autocapitalize]]"
				autocorrect$="[[autocorrect]]">

			<template is="dom-if" if="[[errorMessage]]">
				<paper-input-error>[[errorMessage]]</paper-input-error>
			</template>

		</paper-input-container>
	</template>
	<script>
		Polymer( {
			is: "input-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				FieldBehavior,
				ModernizrBehavior
			],
			properties: {
				compact: {
					value: false,
					type: Boolean
				},
				noLabelFloat: {
					type: Boolean,
					computed: "_noLabelFloat(floatingLabel)"
				},
				floatingLabel: {
					value: "true",
					type: String
				},
				name: {
					type: String
				},
				type: {
					value: "text",
          observer: "typeChanged",
					type: String
				},
				step: {
					type: String
				},
				max: {
					type: String
				},
				min: {
					type: String
				}
			},
			hasDate: false,//Modernizr.inputtypes.date && Modernizr.desktop !== true,
			observers: [
				'editValueChanged(editValue)',
				'valueChanged(value)',
				'validateAttributes(type)'
			],
			_noLabelFloat: function() {
				return this.floatingLabel === "false" || this.floatingLabel === false;
			},
			typeChanged: function() {
				if( this.type && this.type.match(/^date/) ){
					this._origType = this.type;
					if( !this.hasDate ){
						this.type = "text";
						this.$.input.setAttribute( 'type', "text" );
					}
				}
				if( this.type && this.type.match(/^password/) ){
					this.autocomplete="new-password";
				}
			},
			isNumber:function(){
				if( this.type && this.type.match(/^number$/) && !this.isDecimal() ){
					return true;
				}
				return false;
			},
			isDecimal:function(){
				if( this._origType && this._origType.match(/^decimal/) ){
					return true;
				}
				return false;
			},
			isDate:function(){
				if( this.isDateYearMonth()) return true;
				if( this._origType && this._origType.match(/^date/) ){
					return true;
				}
				return false;
			},
			isDateYearMonth:function(){
				if( this._origType && this._origType.match(/^dateyearmonth/) ){
					return true;
				}
				return false;
			},
			isDateTime:function(){
				if( this._origType && this._origType.match(/^datetime/) ){
					return true;
				}
				return false;
			},
			created: function() {
				this._origType=null;
			},
			ready: function() {
				var self = this;
				Object.keys( this.properties ).forEach( function( key ) {
					var value = self.properties[ key ];
					if ( value === undefined && self[ key ] === undefined ) {
						if ( self.$.input.hasAttribute( key ) ) {
							self.$.input.removeAttribute( key );
						}
					}
				} );
			},
			attached: function() {
				//this.pickerType = "pikaday";
				this.pickerType = "bootstrap";
				if ( this.label == null || this.label == '' ) this.label = this.name;
				this.validateAttributes();
				this.decorator = this.$.decorator;
				this.input = this.$.input;
				this.validateAttributes();
				if ( this.type == "number" ) {
					this.preventInvalidInput = true;
				}
				var showTime = this.isDateTime();
				if ( this.isDate() && !this.hasDate ) {
					this.datetimePicker = this.getDatePicker(showTime, {}/*options*/);
					if( this.hasTouch()){
						if( window.isGes != true){
							this.readonly = true;
						}
					}
					if ( this._date ) {
						this.datetimePickerGotoDate(this._date);
					}
				}
				if ( this.isDate() && this.hasDate ) {
					this.async( function() {
						this.decorator._inputHasContent = true;
						this.alwaysFloatLabel=true;
					} );
				}
				if ( this.compact ) {
					jQuery( this.decorator ).addClass( "compact" );
					jQuery( this.$.input ).addClass( "compact" );
					if ( is_chromium && !this.isDate() ) {
						jQuery( this.$.input ).css( "margin-top", "0px" );
					}
				}
			},
			i18n_de: {
				previousMonth: 'Vorheriger Monat',
				nextMonth: 'Nächster Monat',
				months: [ 'Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember' ],
				weekdays: [ 'Sontag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag' ],
				weekdaysShort: [ 'So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa' ]
			},
			i18n_en: {
				previousMonth: 'Previous Month',
				nextMonth: 'Next Month',
				months: [ 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ],
				weekdays: [ 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday' ],
				weekdaysShort: [ 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat' ],
				midnight: 'Midnight',
				noon: 'Noon'
			},
			tooltips: {
				today: 'Go to today',
				clear: 'Clear selection',
				close: 'Close the picker',
				selectMonth: 'Select Month',
				prevMonth: 'Previous Month',
				nextMonth: 'Next Month',
				selectYear: 'Select Year',
				prevYear: 'Previous Year',
				nextYear: 'Next Year',
				selectDecade: 'Select Decade',
				prevDecade: 'Previous Decade',
				nextDecade: 'Next Decade',
				prevCentury: 'Previous Century',
				nextCentury: 'Next Century',
				pickHour: 'Pick Hour',
				incrementHour: 'Increment Hour',
				decrementHour: 'Decrement Hour',
				pickMinute: 'Pick Minute',
				incrementMinute: 'Increment Minute',
				decrementMinute: 'Decrement Minute',
				pickSecond: 'Pick Second',
				incrementSecond: 'Increment Second',
				decrementSecond: 'Decrement Second',
				togglePeriod: 'Toggle Period',
				selectTime: 'Select Time'
			},
			tooltips_de: {
				today: 'Heute auswählen',
				clear: 'Löschen',
				close: 'Schließen',
				selectMonth: 'Monat auswählen',
				prevMonth: 'vorheriger Monat',
				nextMonth: 'nächster Monat',
				selectYear: 'Jahr auswählen',
				prevYear: 'vorheriges Jahr',
				nextYear: 'nächstes Jahr',
				selectDecade: 'Dekade auswählen',
				prevDecade: 'vorherige Dekade',
				nextDecade: 'nächste Dekade',
				prevCentury: 'vorheriges Jahrhundert',
				nextCentury: 'nächstes Jahrhundert',
				pickHour: 'Stunde auswählen',
				incrementHour: 'Stunde +1',
				decrementHour: 'Stunde -1',
				pickMinute: 'Minute auswählen',
				incrementMinute: 'Minute +1',
				decrementMinute: 'Minute -1',
				pickSecond: 'Sekunde auswählen',
				incrementSecond: 'Sekunde +1',
				decrementSecond: 'Sekunde -1',
				togglePeriod: 'Periode umschalten',
				selectTime: 'Zeit auswählen'
			},
			isAuthorizedType: function() {
				var okTypes = [ 'checkbox', 'color', 'date', 'datetime', 'datetime-local', 'dateyearmonth', 'email', 'file', 'month', 'number', 'password', 'radio', 'range', 'tel', 'text', 'time', 'url', 'week' ];
				return ( okTypes.indexOf( this.type ) != -1 );
			},
			lpad: function pad( value, length ) {
				length = length || 2;
				return ( value.toString().length < length ) ? this.lpad( "0" + value, length ) : value;
			},
			validateAttributes: function() {
				if ( !this.input ) {
					return;
				}
				if ( this.type != 'text' && !this.isAuthorizedType() ) {
					this._origType = this.type;
					if( this.type == "double" || this.type == "decimal"){
						this.step = "0.01";
						this.type = 'number';
					}else if( this.type == "integer"){
						this.step = "1";
						this.type = 'number';
					}else{
						this.type = 'text';
					}
				}
				if( is_edge && this.type == "number"){
					this.type = "text";
				}
				if ( this.isDateTime() && this.hasDate) {
					this.input.setAttribute( 'type', "datetime-local" );
				}else if ( this.isDateYearMonth() && this.hasDate) {
					this.input.setAttribute( 'type', "date" );
				} else {
					this.input.setAttribute( 'type', this.type );
				}
			},
			committedValueChanged: function() { //@@@MS ???
			},
			editValueChanged: function() {
				//this.$.input.focus();
				if ( this.type == null ) return;
				if ( this.isDate() && !this.hasDate ) {
					this.value = this._i18nToIso( this.editValue );
				} else {
					this.value = this.editValue;
				}
				if ( this.editValue ) {
					//this.$.decorator.updateLabelVisibility( "X" );
				} else {
					//this.$.decorator.updateLabelVisibility( "" );
				}
				this.fire( 'value-changed', this );
			},
			valueChanged: function() {
				if ( !this.$.decorator ) return;
				if ( this.withoutCheck ) {
					this.withoutCheck = false;
					return;
				}
				this.checkConstraints();
			},
			setValue: function( v ) {
				if ( this.isDate() ) {
					if ( !this.hasDate ) {
						v = this._convertDate( v );
					} else {
						v = this._toIso( v );
					}
				}
				this.editValue = v;
			},
			getValue: function() {
				if ( this.isDate() ) {
					if ( typeof this.value === "string" && !this._isIsoDate(this.value) ) {
						return null;
					}
				}
				if ( this.isNumber() ) {
					if( this.value != null){
						return parseInt(this.value);
					}
				}
				if ( this.isDecimal() ) {
					if( this.value != null){
						if ( typeof this.value === "string" && this.value.indexOf(",")>=0) {
							this.value = this.value.replace(/,/,".");
						}	
						return parseFloat(this.value);
					}
				}
				
				if( this.value == null && this.convertNullToEmpty ){
					return "";
				}
				return this.value;
			},
			getDatePicker:function(showTime,options){
				if( this.pickerType == "pikaday"){
					var picker = new Pikaday( {
						field: this.$.input,
						trigger: this.$.input,
						onSelect: function( a ) {}.bind( this ),
						i18n: simpl4.util.BaseManager.getLanguage() == 'de' ? this.i18n_de : this.i18n_en,
						format: simpl4.util.BaseManager.getDateFormat() + ( showTime ? " HH:mm" : "" ),
						showTime: showTime,
						showSeconds: false,
						use24hour: simpl4.util.BaseManager.getLanguage() == 'de' ? true : false,
						firstDay: 1,
						//minDate: new Date( '2000-01-01' ),
						//maxDate: new Date( '2020-12-31' ),
						yearRange: [ 1900, 2030 ]
					} );
					return picker;
				}
				if( this.pickerType == "bootstrap"){
					var _format= simpl4.util.BaseManager.getDateFormat() + ( showTime ? " HH:mm" : "" );
					var viewMode = this.isDateYearMonth() ? "years" : "days";
					var showComponents = "MYd";
					if( this.isDateYearMonth()){
						showComponents = "MY";
					}else{
						if( this.isDateTime() ){
							showComponents = "MYdhm";
						}else{
							showComponents = "MYd";
						}
					}
					var tooltips = this["tooltips_"+simpl4.util.BaseManager.getLanguage()];
					var locale =  simpl4.util.BaseManager.getLanguage();
					var picker = $(this.$.input).datetimepicker( {locale:locale, viewMode:viewMode, showComponents:showComponents, ignoreReadonly:true, tooltips:tooltips, focusOnShow:false, format:_format, showTodayButton:true, showClear:false, showClose:true});
					var self = this;
					picker.on("dp.change", function(e){
						//console.log("change.date:",e.date.toDate());
						//console.log("change.val:",$(self.$.input).val());
						self.editValue = $(self.$.input).val();
					});
					return picker;
				}
			},
			datetimePickerGotoDate:function(date){
				if( this.pickerType == "pikaday"){
					this.datetimePicker.gotoDate( date );
				}
				if( this.pickerType == "bootstrap"){
				}
			},
			_convertDate: function( v ) {
				if ( !v ) {
					if ( this.datetimePicker ) {
						this.datetimePickerGotoDate(new Date());
					} else {
						this._date = new Date();
					}
					return null;
				}
				var iso = this._toIso( v );
				this._date = this._isoToDate( iso );
				if ( this.datetimePicker ) {
					this.datetimePickerGotoDate(this._date);
					this._date = null;
				}
				return this._isoToI18n( iso );
			},
			_toIso: function( v ) {
				var iso = v;
				var isString = ( typeof v ) === "string";
				var isNumber = ( typeof v ) === "number";
				if ( isNumber || isString && !v.match( /[-]/ ) ) {
					var showTime = this.isDateTime();
					iso = moment( parseInt( v ) ).format( showTime ? "YYYY-MM-DDTHH:mm" : "YYYY-MM-DD" );
				}
				return iso;
			},
			_isoToI18n: function( iso ) {
				var mdate = moment( iso );
				var showTime = this.isDateTime();
				var format = simpl4.util.BaseManager.getDateFormat() + ( showTime ? " HH:mm" : "" );

				var i18n = mdate.format( format );
				return i18n;
			},
			_isoToDate: function( iso ) {
				var mdate = moment( iso );
				return mdate.toDate();
			},
			_i18nToIso: function( i18n ) {
				var iso;
				if ( this.isDateTime() ) {
					var mdate = moment( i18n, simpl4.util.BaseManager.getDateFormat() + " HH:mm" );
					iso = mdate.year() + "-" + this.lpad( ( mdate.month() + 1 ) ) + "-" + this.lpad( mdate.date() ) + "T" + this.lpad( mdate.hour() ) + ":" + this.lpad( mdate.minute() );
				} else {
					var mdate = moment( i18n, simpl4.util.BaseManager.getDateFormat() );
					iso = mdate.year() + "-" + this.lpad( ( mdate.month() + 1 ) ) + "-" + this.lpad( mdate.date() );
				}
				return iso;
			},
			_isIsoDate:function(s){
				var hasTime = this.isDateTime();
				if( hasTime){
 					return s.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/);
				}else{
 					return s.match(/(\d{4})-(\d{2})-(\d{2})/);
				}
			},
			setErrorMessage: function( message ) {
				this.errorMessage = message;
			},
			setInvalid: function( b ) {
				if ( this.decorator == null ) return;
				this.invalid = b;
			},
			hasTouch:function(){
				return  (('ontouchstart' in window) || window.DocumentTouch && document instanceof window.DocumentTouch);
			},
			setCustomValidity: function( message ) {
				//Dummy,regula want access this
			}
		} );

	</script>
</dom-module>

<dom-module id="multiline-field">
	<style>
		:host {
			--paper-input-container: {
					padding: 0px;
			};
		}
		:host /deep/ .input-content.paper-input-container{
	    line-height: 22px;
		}
		:host #input /deep/ textarea{
			font-size: 14px;
			font-weight: normal;
	    line-height: 20px;
		}
		:host /deep/ iron-autogrow-textarea{
	    line-height: 20px !important;
		}
	</style>
	<template>
    <paper-input-container id="decorator" no-label-float$="[[noLabelFloat]]" always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]" disabled$="[[disabled]]" invalid="[[invalid]]">

      <label hidden$="[[!label]]">[[label]]</label>
			<paper-tooltip for="" position="bottom" xffset="0">[[help]]</paper-tooltip>

      <iron-autogrow-textarea id="input" class="paper-input-input"
        bind-value="{{editValue}}"
        autocomplete$="[[autocomplete]]"
        autofocus$="[[autofocus]]"
        inputmode$="[[inputmode]]"
        name$="[[name]]"
        placeholder$="[[placeholder]]"
        readonly$="[[readonly]]"
        required$="[[required]]"
        maxlength$="[[maxlength]]"
        autocapitalize$="[[autocapitalize]]"></iron-autogrow-textarea>

      <template is="dom-if" if="[[errorMessage]]">
        <paper-input-error>[[errorMessage]]</paper-input-error>
      </template>

    </paper-input-container>
	</template>
	<script>
		Polymer( {
			is: "multiline-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				FieldBehavior
			],
			observers: [
				'editValueChanged(editValue)'
			],
			properties: {
			},
			editValueChanged: function() {
				this.value = this.editValue;
				this.fire( 'value-changed', this );
			},
			valueChanged: function() {
				if ( !this.$.decorator ) return;
				if ( this.withoutCheck ) {
					this.withoutCheck = false;
					return;
				}
				this.checkConstraints();
			},
			setValue: function( v ) {
				this.editValue = v;
			}
		} );

	</script>
</dom-module>

<dom-module id="upload-field">
	<style>
		:host {
			--paper-input-container: {
				padding: 0px;
			}
			;
		}
		:host #input {
			font-size: 12px;
		}
		:host /deep/ .underline{
			display:none;
		}
		.error {
			color: #d34336;
		}
		.error-text {
			font-size: 0.75em;
			padding: 0.5em 0;
		}
		[invisible] {
			visibility: hidden;
		}
		label.label-text {
			top:10px !important;
			font-size:14px !important;
			display: inline-block;
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
	</style>
	<template>
		<paper-input-container id="decorator" no-label-float$="[[noLabelFloat]]" always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]" disabled$="[[disabled]]" invalid="[[invalid]]">
			<div class="layout horizontal">
				<div hidden$="[[!label]]" style="width:3%;">
					<label class="label-text">{{label}}</label>
				</div>
				<simpl-upload id="input" maxsize="{{maxsize}}" multi="{{multi}}" class="paper-input-input" drop-text="[[tr('import.drop_file2')]]" droppable="true" raised="true">[[tr('import.select_file')]]</simpl-upload>
			</div>
			<template is="dom-if" if="[[errorMessage]]">
				<paper-input-error>[[errorMessage]]</paper-input-error>
			</template>

			<div class="error layout horizontal center" hidden$="[[!isInvalid]]">
				<div class="error-text flex auto" role="alert" aria-hidden$="[[!isInvalid]]"></div>
				<div class="error-text" role="alert" aria-hidden$="[[!isInvalid]]">{{error}}<span>&nbsp;&nbsp;</span></div>
				<iron-icon class="error-icon" icon="warning"></iron-icon>
			</div>
		</paper-input-container>
	</template>
	<script>
		Polymer( {
			is: "upload-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				TranslationsBehavior,
				FieldBehavior
			],
			listeners: {
				'upload-complete': 'valueChanged'
			},
			properties: {
				required: {
					value:"",
					type: String
				},
        value: {
         type: Object
        },
				maxsize: {
					value: 0
				},
				multi: {
					type: Boolean,
					value: true
				}
			},
			ready: function() {
				this.isInvalid = false;
			},
			valueChanged: function( e ) {
				var f = this.form._getField( "filename" );
				if ( f != null ) {
					f.setValue( e.detail.target.file.name );
				}
				if( this.multi ){
					this.value[ e.detail.target.file.name ] =  e.detail.target.result;
				}else{
					this.value = {};
					this.value[ e.detail.currentTarget.file.name] =  e.detail.currentTarget.result;
				}
				this.fire( 'value-changed', this );
				this.checkConstraints();
			},
			getValue: function() {
				//console.log("upload.getValue",this.value); //@@@MS Incombatible change
				return this.value;
			},
			setValue: function( v ) {
				this.value = {};
				this.disabled = false;
				var f = this.form._getField( "filename" );
				if ( f != null && !this.isEmpty( f.getValue() ) ) {
					this.disabled = true;
				}
				this.$.input.clear();
			},
			checkConstraints: function() {
				this.setInvalid( false );
				if ( !this.isRequired() ) return;
				if ( Object.keys(this.value).length>0 ) {
					return;
				}
				this.setInvalid( true );
				this.setErrorMessage( tr( "This field is required" ) );
			},
			setErrorMessage: function( message ) {
				this.error = message;
			},
			setInvalid: function( b ) {
				this.isInvalid = b;
			},
			isRequired: function() {
				var data = this.form._getData();
				var req = this.form._maskedEval( this.required, data, false );
				return req;
			},
			isEmpty: function( s ) {
				if ( s == null || s == '' ) return true;
				return false;
			}
		} );
	</script>
</dom-module>

<dom-module id="custom-field">
	<style>
		#insertPoint{
		}

		:host #label {
			padding: 0 !important;
			font-size: 14px;
			font-weight: normal;
		}
	</style>
	<template>
		<div id="insertPoint"></div>
	</template>
	<script>
		Polymer( {
			is: "custom-field",
			behaviors: [ FieldBehavior ],
			properties: {
				elementname: {
					type: String
				},
				url: {
					observer: 'urlChanged',
					type: String
				}
			},
			observers: [
				//'valueChanged(value)'
			],

			urlChanged:function(){			
				if( this.url == null) return;
				this.importHref( this.url+"?time="+(new Date().getTime()), this.onResponse.bind( this ) );
			},

			onResponse: function( e ) {
				var body = e.target.import.body;

				var insertPoint = this.$.insertPoint;
				while ( insertPoint.firstChild ) {
					Polymer.dom( insertPoint ).removeChild( insertPoint.firstChild );
				}
				if ( body && body.firstElementChild ) {
					if($(body).children().length == 1 ){
						Polymer.dom( insertPoint ).appendChild( body.firstElementChild );
					}else{
						Polymer.dom( insertPoint ).appendChild( body);
					}
				}
				this.field  = this.querySelector(this.elementname);
				this.field.setValue(this.value);
				console.log("Custom("+this.name+").setValue:",this.value);
				this.field.label = this.label;
			},
			setValue:function(v){
				this.value = v;
				if( this.field==null) return;
				console.log("Custom("+this.name+").setValue:",this.value);
				this.field.setValue(v);
			},
			getValue:function(){
				 if( this.field==null){
					 console.log("custom-field.getValue:field is null");
					 return null;
				 }
				this.value=this.field.getValue();
				console.log("Custom("+this.name+").getValue:",this.value);
				return this.value;
			},
			valueChanged: function( e ) {
				if ( this.isDomReady != true ) return;
				if ( this.withoutCheck ) {
					this.withoutCheck = false;
					return;
				}
				//this.checkConstraints();
			}
		} );

	</script>
</dom-module>

<dom-module id="checkbox-field">
	<style>
		:host {
			padding: 13px !important;
			display:inline-block;
		}
		:host.compact {
			padding: 0 !important;
		}
		paper-input-error{
			visibility:visible;
		}

	</style>
	<template>
		<div class="vertical layout">
			<paper-checkbox disabled$="[[disabled]]" checked="{{value}}">
				<label id="label" hidden$="[[!label]]">[[label]]</label>
			  <paper-tooltip for="" position="bottom" xffset="0">[[help]]</paper-tooltip>
			</paper-checkbox>

			<template is="dom-if" if="[[errorMessage]]">
				<paper-input-error>[[errorMessage]]</paper-input-error>
			</template>
		</div>


	</template>
	<script>
		Polymer( {
			is: "checkbox-field",
			behaviors: [ FieldBehavior ],
			properties: {
				compact: {
					value: false,
					type: Boolean
				}
			},
			observers: [
				'valueChanged(value)'
			],
			attached:function(){
				if( this.compact){
					jQuery( this ).addClass( "compact" );
				}
			},
			setValue:function(v){
				this.value = v;
			},
			getValue:function(){
				return this.value;
			},
			valueChanged: function( e ) {
				if ( this.isDomReady != true ) return;
				if ( this.withoutCheck ) {
					this.withoutCheck = false;
					return;
				}
				this.checkConstraints();
				this.fire( 'value-changed', this );
			}
		} );

	</script>
</dom-module>


<dom-module id="toggle-field">
	<style>
		.floated-label {
			font-size: 0.75em;
			padding: 1em 0;
			white-space: nowrap;
			color: #757575;
		}
		.label-text {
			display: inline-block;
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		.container {
			font-size: 0.75em;
			color: #757575;
		}

	</style>
	<template>
		<div class="floated-label" invisibxe?="{{value === undefined}}">
			<span class="label-text">{{label}}</span>
		</div>
		<paper-toggle-button checked="{{value}}"></paper-toggle-button>
	</template>

	<script>
		Polymer( {
			is: "toggle-field"
		});
	</script>
</dom-module>


<dom-module id="slider-field" extends="form-field" kind="slider" attributes="minLabel maxLabel" noscript>
	<style>
		.floated-label {
			font-size: 0.75em;
			padding: 1em 0;
			white-space: nowrap;
			color: #757575;
		}
		.label-text {
			display: inline-block;
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		paper-slider /deep/ #sliderBar {
			box-sizing: initial;
		}
		.container {
			font-size: 0.75em;
			color: #757575;
		}

	</style>
	<template>
		<div class="floated-label" invisible?="{{value === undefined}}">
			<span class="label-text">{{label}}</span>
		</div>
		<div class="container" layout horizontal center>
			{{minLabel}}
			<paper-slider flex value="{{value}}"></paper-slider>
			{{maxLabel}}
		</div>
	</template>
</dom-module>


<dom-module id="radio-field" extends="form-field" kind="radio-group" noscript>
	<template>
		<style>
			.floated-label {
				font-size: 0.75em;
				padding: 1em 0;
				white-space: nowrap;
				color: #757575;
			}
			.label-text {
				display: inline-block;
				white-space: nowrap;
				text-overflow: ellipsis;
				overflow: hidden;
			}
			::content > paper-radio-button {
				font-size: 0.75em;
				padding: 1em;
			}

		</style>
		<div class="floated-label" invisible?="{{value === undefined}}">
			<span class="label-text">{{label}}</span>
		</div>
		<paper-radio-group selected="{{value}}" layout vertical>
			<content></content>
		</paper-radio-group>
	</template>
</dom-module>

<link rel="import" type="css" href="selectize.bootstrap3.css" />
<dom-module id="select-field">
	<style>
		:host {
			padding: 0.75em 0;
			--paper-input-container: {
				padding: 0px;
			}
			;
		}
		:host.compact {
			padding: 0;
		}
		:host #decorator.compact {
			padding: 0;
			margin: 0px;
		}
		:host #decorator {
			line-height: 1;
		}
		:host /deep/ .floated-label-placeholder.compact {
			display: none;
		}
		:host #label.compact {
			display: none;
		}
		:host #label {
			font-size: 14px;
		}
		:host /deep/ .input-content.paper-input-container{
	    line-height: 18px;
		}
		:host.compact /deep/ input {
			width: initial !important;
			position:relative !important;
		}
		:host /deep/ .selectize-input > * {
			vertical-align: baseline;
			font-size:14px;
			height:22px;
		}
		:host.compact /deep/ .selectize-dropdown {
			position: absolute !important;
		}
		:host:not(.compact) /deep/ .selectize-dropdown {
			margin-top:2px;
		}
		:host /deep/ .selectize-input {
			border: 0px !important;
			padding:0px !important;
			border-radius:0px !important;
			line-height:15px;
			min-height:22px;
		}
		:host /deep/ .selectize-input.focus {
			box-shadow: inset 0 0px !important;
		}
		:host /deep/ div.dropdown-field > input.fakeinput {
			font-size: 14px !important;
		}
		:host /deep/ .selectize-input /deep/ input {
			max-height:15px !important;
			font-size:12px !important;
			font-weight:200 !important;
		}

	</style>
	<template>
		<paper-input-container id="decorator" no-label-float="[[noLabelFloat]]" always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]" readonly disabled$="[[disabled]]" invalid="[[isInvalid]]">
			<label id="label" hidden$="[[!label]]">[[label]]</label>
			<paper-tooltip for="" position="bottom" xffset="0">[[help]]</paper-tooltip>
			<input hidden is="iron-input" id="input" bind-value="[[value]]" />
			<div>
				<select multiple$=[[multiple]]  id="select" name="[[name]]">
				</select>
			</div>
      <template is="dom-if" if="[[errorMessage]]">
        <paper-input-error hidden$="[[!isInvalid]]">[[errorMessage]]</paper-input-error>
      </template>
		</paper-input-container>
	</template>
	<script>
		Polymer( {
			is: "select-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				StyleScopeBehavior,
				FieldBehavior
			],
			_listeners: {
				'value-changed': 'ignore'
			},
			properties: {
				multiple: {
					value: false
				},
				compact: {
					value: false
				},
				jsonItems: {
					type: String
				},
				items: {
					observer:"itemsChanged",
					type: Object
				},
				required: {
					value: "false",
					type: String
				},
				delimiter: {
						type: String,
						value: ','
				},
				combobox: {
						type: Boolean,
						value: false
				},
				diacritics: {
						type: Boolean,
						value: true
				},
				createFilter: {
						type: String,
						value: null
				},
				highlight: {
						type: Boolean,
						value: true
				},
				persist: {
						type: Boolean,
						value: false
				},
				openOnFocus: {
						type: Boolean,
						value: true
				},
				maxOptions: {
						type: Number,
						value: 1000
				},
				maxItems: {
						type: Number,
						value: 1
				},
				hideSelected: {
						type: Boolean,
						value: true
				},
				closeAfterSelect: {
						type: Boolean,
						value: false
				},
				allowEmptyOption: {
						type: Boolean,
						value: false
				},
				scrollDuration: {
						type: Number,
						value: 60
				},
				loadThrottle: {
						type: Number,
						value: 300
				},
				loadingClass: {
						type: String,
						value: 'loading'
				},
				preload: {
						type: String, //check if it works
						value: false
				},
				dropdownParent: {
						type: String,
						value:"body" 
				},
				addPrecedence: {
						type: Boolean,
						value: false
				},
				selectOnTab: {
						type: Boolean,
						value: false
				},
				options: {
						type: Array,
						value: []
				},
				optgroups: {
						type: Array,
						value: []
				},
				dataAttr: {
						type: String,
						value: 'data-data'
				},
				valueField: {
						type: String,
						value: 'value'
				},
				optgroupValueField: {
						type: String,
						value: 'value'
				},
				labelField: {
						type: String,
						value: 'text'
				},
				optgroupLabelField: {
						type: String,
						value: 'label'
				},
				optgroupField: {
						type: String,
						value: 'optgroup'
				},
				sortField: {
						type: String,
						value: '$order'
				},
				searchField: {
						type: Array,
						value: ['text']
				},
				searchConjunction: {
						type: String,
						value: 'and'
				},
				lockOptgroupOrder: {
						type: Boolean,
						value: false
				},
				copyClassesToDropdown: {
						type: Boolean,
						value: true
				},
				ajaxOptions: {
						type: String,
						value: null
				},
				ajaxOptionsRoot: {
						type: String,
						value: null
				},
				ajaxOptionsDataType: {
						type: String,
						value: null
				},
				mutationObserver: {
					value: ( function() {
						var observer = new MutationObserver( this.mutated.bind(this) );
						observer.observe( this, {
							attributes: true,
							attributeOldValue: true,
							attributeFilter: [ 'disabled' ]
						} );
						return observer;
					} ),
				}
			},
			listeners: {
				'value-changed': '_formValueChanged'
			},
			observers: [
				'valueChanged(value)',
				'compactChanged(compact)',
				'jsonItemsChanged(jsonItems)'
			],
			mutated: function( mutations ) {
				var self = this;
				mutations.forEach( function( mutation ) {
					var entry = {
						name: mutation.target.getAttribute( "name" ),
						value: mutation.target.getAttribute( "disabled" ),
						oldValue: mutation.oldValue
					};
					if ( entry.oldValue == entry.value ) {
						return;
					}
					var fl = self.querySelector( ".focused-line" );
					var inp = self.querySelector("input[type=\"text\"]");

					if( fl == null) return;
					if ( entry.value == "r" ) {
						fl.style.display = "none";
						if( inp) inp.setAttribute("tabindex", "-1");
					} else {
						fl.style.display = "block";
						if( inp) inp.removeAttribute("tabindex");
					}

				})
			},
			ready: function() {
				this.isInvalid = false;
			},
			compactChanged: function( ) {
				if( this.compact === false) return;
				this.async( function() {
					jQuery( this.decorator ).addClass( "compact" );
					jQuery( this.$.label ).addClass( "compact" );
					jQuery( this ).addClass( "compact" );
					var e = this.$.decorator.querySelector( ".floated-label-placeholder" );
					jQuery( e ).addClass( "compact" );
				}, 20 );
			},
			jsonItemsChanged: function( v ) {
				var o = JSON.parse( this.jsonItems );
				this.items = o;
			},
			setItems: function( items ) {
				this.items = items;
			},
			itemsChanged:function(){
				if( this.form == null && !_.isEmpty(this.parentName) ) return;
				var select = this.$.select;
				while (select.firstChild) {
    			select.removeChild(select.firstChild);
				}
				if( this.items == null){
					return;
				}
        if( this.selectize){
         this.selectize.clearOptions();
        }
				if( _.isEmpty(this.parentName) || (!_.isEmpty(this.parentName) &&  !_.isEmpty(this.parentValue))){
					if( this.items.length ){
						for( var i=0; i < this.items.length;i++){
							var item = this.items[i];
							var parentList = _.isEmpty(item.parent) ? null : item.parent.split(",");
							if( !_.isEmpty(this.parentValue) && parentList != null && _.indexOf( parentList, this.parentValue)<0){
								continue;
							}
							if( this.selectize){
								this.selectize.addOption({value:item.value,text:item.label});
							}else{
							 var option = document.createElement("option");
							 var label = document.createTextNode(item.label);
							 option.value = item.value;
							 Polymer.dom( option ).appendChild( label );
							 Polymer.dom( select ).appendChild( option );
							}
						}
					}else{
						var items=this.items
						Object.keys(items).forEach(function(k) {
							var item = items[k];
							var parentList = _.isEmpty(item.parent) ? null : item.parent.split(",");
							if( !_.isEmpty(this.parentValue) && parentList != null && _.indexOf( parentList, this.parentValue)<0){
								return;
							}
							if( this.selectize){
								this.selectize.addOption({value:item.value,text:item.label});
							}else{
								var option = document.createElement("option");
								var label = document.createTextNode(item.label);
								option.value = item.value;
								Polymer.dom( option ).appendChild( label );
								Polymer.dom( select ).appendChild( option );
							}
						})
					}
				}
				if( this.selectize){
					this.selectize.refreshOptions(false);
				}
			},
			valueChanged: function( v ) {
				//console.log( "select-field(" + this.name + ").valueChanged:", this.value+"/wo:"+this.withoutCheck );
				if( this._invalueSetting===true) return;
				this.async( function(){
					if( this.selectize && this.selectize.getValue() != this.value){
						this._invalueSetting=true;
						this.selectize.setValue(this.value);
						this._invalueSetting=false;
					}
				},300);
				if ( this.isDomReady != true ) return;
				if ( this.withoutCheck ) {
					this.withoutCheck = false;
					return;
				}
				this.checkConstraints();
			},
			setValue: function( v ) {
				//console.log( "select-field(" + this.name + ").setValue:",v );
				this.value = v;
				if( this.selectize){
					this.selectize.setValue(v);
				}else{
					this.__value = v;
				}
			},
			getValue: function() {
				//console.log( "select-field(" + this.name + ","+this.convertNullToEmpty+"),getValue:", this.value );
				if( this.multiple !== true && this.value && Array.isArray(this.value) && this.value.length>0){
					if( this.value[0] == null && this.convertNullToEmpty ){
						return "";
					}
					return this.value[0];
				}
				if( this.value == null && this.convertNullToEmpty ){
					return "";
				}
				return this.value;
			},
			onFocus: function( val ) {
				//console.log( "select-field(" + this.name + ").onFocus" );
				//this.selectizeControl.blur();
			},
			onCreate: function( tag ) {
				if( this.combobox ){
					return { 'value': tag, 'text': tag };
				}
				return false;
			},
			onChange: function( val ) {
				if( val == 'null') val = null;
				//console.log( "select-field(" + this.name + ").onChange:", this.value+"/val:"+(val==null) );
				if( this.isEmpty(this.value) && this.isEmpty(val)){
					return;
				}
				this.value = val;
				this.fire( 'value-changed', this );
			},
			createSelectize: function() {
				if( this.multiple === true){
					this.maxItems = 1000;
				}
				var options = {
						delimiter: this.delimiter,
						diacritics: this.diacritics,
						create: this.combobox,
						createOnBlur: this.onCreate.bind(this),
						createFilter: this.createFilter,
						highlight: this.highlight,
						persist: this.persist,
						openOnFocus: this.openOnFocus,
						maxOptions: this.maxOptions,
						maxItems: this.maxItems,
						hideSelected: this.hideSelected,
						closeAfterSelect: this.closeAfterSelect,
						alglowEmptyOption: this.allowEmptyOption,
						scrollDuration: this.scrollDuration,
						loadThrottle: this.loadThrottle,
						loadingClass: this.loadingClass,
						preload: this.preload,
						dropdownParent: this.dropdownParent,
						addPrecedence: this.addPrecedence,
						selectOnTab: this.selectOnTab,
						options: this.options,
						optgroups: this.optgroups,
						dataAttr: this.dataAttr,
						valueField: this.valueField,
						optgroupValueField: this.optgroupValueField,
						labelField: this.labelField,
						optgroupLabelField: this.optgroupLabelField,
						optgroupField: this.optgroupField,
						sortField: this.sortField,
						searchField: this.searchField,
						searchConjunction: this.searchConjunction,
						lockOptgroupOrder: this.lockOptgroupOrder,
						copyClassesToDropdown: this.copyClassesToDropdown,
						onChange: this.onChange.bind(this),
						onFocus: this.onFocus.bind(this)
				};
 				var field = this.$.select;
				var $select = $(field).selectize(options);
				this.selectize = $select[0].selectize;
				if( this.__value){
					this.selectize.setValue(this.__value);
					this.__value = null;
				}
			},
			ignore:function(e){
				if( this.parentNode.tagName != "FORM-ELEMENT-RENDERER"){
					e.preventDefault();
					e.stopPropagation();
				}
			},
			attached:function(){
				this.async( function() {
					this._attached();
				});
			},
			_attached: function() {
				this.alwaysFloatLabel = true;
				this.placeholder=" "; //@@@MS is needed to show the floating label, if the the field is empyty.
				//console.log( "select-field(" + this.name + ").attached" );
				this.isDomReady = true;
				if ( this.compact ) {
					this.compactChanged();
				}
				this.createSelectize();
				this.selectizeControl = this.$.decorator.querySelector( ".selectize-control" );
//					jQuery( this.selectizeControl ).css( "pointer-events", "none" );
			},
			isEmpty: function( s ) {
				if( Array.isArray(s)){
					return s.length == 0;
				}
				if ( s == null || s == '' ) return true;
				return false;
			},
			checkConstraints: function() {
				var c = this.getAttribute( "data-constraints" );
				if ( c != null && c.length > 0 ) {
					this._checkConstraints(c);
					return;
				}
				this.setInvalid( false );
				if ( !this.isRequired() ) return;
				if ( !this.isEmpty(this.value) ) {
					return;
				}
				this.setInvalid( true );
				this.setErrorMessage( tr( "This field is required" ) );
			},
			_checkConstraints: function(c) {
				var elements = [ this ];
				regula.bind( {
					elements: elements
				} );
				this.async( function() {
					var errorList = regula.validate( {
						elements: elements
					} );
					this.setInvalid( errorList.length > 0 );
					if ( errorList.length > 0 ) {
						this.setErrorMessage( errorList[ 0 ].message );
					}else{
						this.setErrorMessage( null );
					}
				} );
			},
			setErrorMessage: function( message ) {
				this.errorMessage = message;
			},
			setInvalid: function( b ) {
				this.isInvalid = b;
			},
			_formValueChanged:function( e){
				var name = e.detail.name;
				var list = this.getFieldsWithParent();
				for( var i=0; i < list.length;i++){
					var f = list[i];
					if( f.parentName == name){
						f.parentValue = e.detail.getValue();
						f.itemsChanged();
						f.setValue( f.defaultvalue);
					}
				}
			},
			getFieldsWithParent:function(){
				if( this.fieldsWithParent) return this.fieldsWithParent;
				var list = [];
				if( this.form == null) return [];
				this.form.fields.forEach( function( field ) {
					if( !_.isEmpty(field.parentName)){
						list.push( field);
					}
				}, this );
				this.fieldsWithParent = list;
				return list;
			},
			isParentDest:function(name){
				var list = this.getFieldsWithParent();
				for( var i=0; i < list.length;i++){
					var f = list[i];
					if( f.parentName == name) return true;
				}
				return false;
			},
			setForm: function( form ) {
				this.form = form;
				this.convertNullToEmpty = form._form.xf_string_null_in_empty===true;
				if( this.isParentDest(this.name) || !_.isEmpty(this.parentName) ){
					this.itemsChanged();
				}
				if( this.getValue() == null){
					this.setValue( this.defaultvalue);
				}
			},
			isRequired: function() {
				if( !this.form ) return false;
				var data = this.form._getData();
				var req = this.form._maskedEval( this.required, data, false );
				return req;
			}
		} );

	</script>
</dom-module>

<dom-module id="tree-field">
	<style>
		:host {
			padding: 0.75em 0;
			--paper-input-container: {
				padding: 0px;
			}
			;
		}
		:host.compact {
			padding: 0;
		}
		:host #decorator.compact {
			padding: 0;
			margin: 0px;
		}
		:host #decorator {
			line-height: 1.3;
			font-size: 14px;
		}
		:host /deep/ .floated-label-placeholder.compact {
			display: none;
		}
		:host #label.compact {
			display: none;
		}
		:host #label {
			font-size: 14px;
		}
		:host.compact /deep/ input {
			width: initial !important;
			position:relative !important;
		}

		:host /deep/ #dropdown {
			width: 100%;
			display:inline-block;
			position: relative !important;
			top: 0px !important;
		}


		:host /deep/ #contentWrapper {
			position: absolute;
			width: 100%;
		}

		:host /deep/ .dropdown-content {
			max-height: 300px !important;
		}
		:host /deep/ paper-input-container {
			padding: 0px !important;
		}

	</style>
	<template>
		<paper-dropdown-menu id="dropdownId" style="display:inline !important;" id="decorator" label="[[label]]" no-label-float="[[noLabelFloat]]" always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]" readonly disabled$="[[disabled]]" invalid="[[isInvalid]]">
			<simpl-jqtree style="width:100%;" jqtree="{{jqtree}}" class="dropdown-content" contextmenu="[[contextmenu]]" selected-item="{{selectedItem}}" multi-select="[[multiSelect]]" options="[[options]]" data="[[items]]">
			</simpl-jqtree>
		</paper-dropdown-menu>
      <template is="dom-if" if="[[errorMessage]]">
        <paper-input-error invalid$="[[isInvalid]]">[[errorMessage]]</paper-input-error>
      </template>
	</template>
	<script>
		Polymer( {
			is: "tree-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				StyleScopeBehavior,
				FieldBehavior
			],
			properties: {
				selectedItem: {
					observer: "selectedItemChanged",
					notify: true,
					type: Object
				},
				multiple: {
					value: false
				},
				compact: {
					value: false
				},
				jsonItems: {
					type: String
				},
				items: {
					observer:"itemsChanged",
					type: Object
				},
				required: {
					value: "false",
					type: String
				},
				closeAfterSelect: {
						type: Boolean,
						value: false
				}
			},
			observers: [
				'valueChanged(value)',
				'compactChanged(compact)',
				'jsonItemsChanged(jsonItems)'
			],
			ready: function() {
				this.isInvalid = false;
				this.options = { autoOpen : true }
			},
			compactChanged: function( ) {
				if( this.compact === false) return;
				this.async( function() {
					jQuery( this.decorator ).addClass( "compact" );
					jQuery( this.$.label ).addClass( "compact" );
					jQuery( this ).addClass( "compact" );
					var e = this.$.decorator.querySelector( ".floated-label-placeholder" );
					jQuery( e ).addClass( "compact" );
				}, 20 );
			},
			jsonItemsChanged: function( v ) {
				var o = JSON.parse( this.jsonItems );
				this.items = o;
			},
			itemsChanged:function(){
				console.log( "tree-field(" + this.name + ").itemsChanged:", this.items );
			},
			valueChanged: function( v ) {
				console.log( "tree-field(" + this.name+",wo:"+this.withoutCheck + ").valueChanged:", this.value );
				if ( this.isDomReady != true ) return;
				if ( this.withoutCheck ) {
					this.withoutCheck = false;
					return;
				}
				this.checkConstraints();
			},
			setValue: function( v ) {
				console.log( "tree-field(" + this.name + ").setValue:",v );
				var id = v;
				if( _.isString(v)){
					try{
						id = JSON5.parse(v).id;
					}catch(e){}		
				}
				if( !_.isEmpty(id) ){
					var node = this.jqtree.tree('getNodeById', id);
					this.jqtree.tree('selectNode', node);
					this.jqtree.tree('scrollToNode', node);
					this.$.dropdownId.querySelector("#input").value=node.name;
				}else{
					this.jqtree.tree('selectNode', null);
					this.selectedItem=null;
					this.$.dropdownId.querySelector("#input").value='';
					this.setInvalid( false );
				}
			},
			getValue: function() {
				//console.log( "tree-field(" + this.name + "),getValue:", this.value );
				//if( this.multiple !== true && this.value && Array.isArray(this.value) && this.value.length>0){
				//	return this.value[0];
				//}
				return JSON.stringify(this.value);
			},
			selectedItemChanged: function( val ) {
				console.log( "tree-field(" + this.name + ").selectedItemChanged:", this.value+"/val:"+val );
				this.value = val;
				this.checkConstraints();
				this.fire( 'value-changed', this );
			},
			attached:function(){
				this.async( function() {
					this._attached();
				});
			},
			_attached: function() {
				this.alwaysFloatLabel = true;
				this.placeholder=" "; //@@@MS is needed to show the floating label, if the the field is empyty.
				console.log( "tree-field(" + this.name + ").attached" );
				this.isDomReady = true;
				if ( this.compact ) {
					this.compactChanged();
				}
			},
			isEmpty: function( s ) {
				if( Array.isArray(s)){
					return s.length == 0;
				}
				if ( s == null || s == '' ) return true;
				return false;
			},
			checkConstraints: function() {

				console.log( "tree-field(" + this.name + ").checkConstraints" );
				this.setInvalid( false );
				if ( !this.isRequired() ) return;
				if ( !this.isEmpty(this.value) ) {
					return;
				}
				console.log( "tree-field(" + this.name + ").checkConstraints2" );
				this.setInvalid( true );
				this.setErrorMessage( tr( "This field is required" ) );
			},
			setErrorMessage: function( message ) {
				this.errorMessage = message;
			},
			setInvalid: function( b ) {
				this.isInvalid = b;
			},
			isRequired: function() {
				var data = this.form._getData();
				var req = this.form._maskedEval( this.required, data, false );
				return req;
			}
		} );

	</script>
</dom-module>

<dom-module id="dropdown-field">
	<link rel="import" type="css" href="jquery.dropdown.css" />
	<style>
		:host {
			padding: 0.75em 0;
			--paper-input-container: {
				padding: 0px;
			}
			;
		}
		:host.compact {
			padding: 0;
		}
		:host #decorator.compact {
			padding: 0;
			margin: 0px;
		}
		:host /deep/ .floated-label-placeholder.compact {
			display: none;
		}
		:host #label.compact {
			display: none;
		}
		:host /deep/ div.dropdown-field > input.fakeinput {
			font-size: 14px !important;
		}

	</style>
	<template>
		<paper-input-container id="decorator" no-label-float="[[noLabelFloat]]" always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]" readonly disabled$="[[disabled]]" invalid="[[invalid]]">
			<label id="label" hidden$="[[!label]]">[[label]]</label>
			<paper-tooltip for="" position="bottom" xffset="0">[[help]]</paper-tooltip>
			<input hidden is="iron-input" id="input" bind-value="[[value]]" />
			<select multiple$=[[multiple]]  id="select" name="[[name]]">
				<!--template is="dom-repeat" as="i" items="{{items}}">
					<option value$="{{i.value}}">{{i.label}}</option>
				</template-->
			</select>
      <template is="dom-if" if="[[errorMessage]]">
        <paper-input-error>[[errorMessage]]</paper-input-error>
      </template>
		</paper-input-container>
	</template>
	<script>
		Polymer( {
			is: "dropdown-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				StyleScopeBehavior,
				FieldBehavior
			],
			properties: {
				multiple: {
					value: false
				},
				compact: {
					value: false
				},
				_dropdown: {
					type: Object
				},
				jsonItems: {
					type: String
				},
				items: {
					observer:"itemsChanged",
					type: Object
				}
			},
			observers: [
				'valueChanged(value)',
				'compactChanged(compact)',
				'jsonItemsChanged(jsonItems)'
			],
			compactChanged: function( ) {
				if( this.compact === false) return;
				this.async( function() {
					jQuery( this.decorator ).addClass( "compact" );
					jQuery( this.$.label ).addClass( "compact" );
					jQuery( this ).addClass( "compact" );
					var e = this.$.decorator.querySelector( ".floated-label-placeholder" );
					jQuery( e ).addClass( "compact" );
				}, 20 );
			},
			jsonItemsChanged: function( v ) {
				var o = JSON.parse( this.jsonItems );
				this.items = o;
			},
			itemsChanged:function(){
				var select = this.$.select;
				while (select.firstChild) {
    			select.removeChild(select.firstChild);
				}
				if( this.items == null){
					return;
				}
				for( var i=0; i < this.items.length;i++){
					var item = this.items[i];
					var option = document.createElement("option");
					var label = document.createTextNode(item.label);
					option.value = item.value;
					Polymer.dom( option ).appendChild( label );
					Polymer.dom( select ).appendChild( option );
				}
			},
			valueChanged: function( v ) {
				//console.log( "drop-field(" + this.name + ").valueChanged:", this.value+"/wo:"+this.withoutCheck );
				if ( this.isDomReady != true ) return;
				if ( this.withoutCheck ) {
					this.withoutCheck = false;
					return;
				}
				this.checkConstraints();
			},
			setValue: function( v ) {
				this._dropdown.data( "options", this._options );
				//console.log( "drop-field(" + this.name + ").setValue:",v+"/"+ this._dropdown.data( "options" ) );
				this.value = v;

				this.async( function() {
					$( this._dropdown ).dropdown( "select", this.value );
				},10 );
			},
			getValue: function() {
				//console.log( "drop-field(" + this.name + "),GetValue:", this.value );
				return this.value;
			},
			onSelected: function( val ) {
				if( val == undefined) return;
				//console.log( "drop-field(" + this.name + ").onSelected:", this.value+"/val:"+val );
				this.value = val;
				this.fire( 'value-changed', this );
			},
			onCallback: function( dropdown ) {
				this._dropdown = dropdown;
				this.setStyleScope( this._dropdown.get( 0 ), "style-scope", this.tagName.toLowerCase() );
			},
			attached: function() {
				this.isDomReady = true;
				if ( this.compact ) {
					this.compactChanged();
				}
				this._options = {
					onSelected: this.onSelected.bind( this ),
					callback: this.onCallback.bind( this ),
					optionClass: this.name
				}
				this.async( function() {
				//console.log( "drop-field(" + this.name + ").create" );
					$( this.$.select ).dropdown( this._options );
				} );
			}
		} );

	</script>
</dom-module>


<dom-module id="gridinput-field">
	<style>
		.error {
			color: #d34336;
		}
		.error-text {
			font-size: 0.75em;
			padding: 0.5em 0;
		}
		[invisible] {
			visibility: hidden;
		}
		.floatedLabel {
			font-size: 1.05em;
			white-space: nowrap;
			color: #757575;
			padding: 0.4em;
		}
		.label-text {
			display: inline-block;
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		grid-element-renderer {
			padding-left: 3px;
			padding-right: 3px;
			line-height:20px;
		}
		:host paper-icon-button {
			padding: 0px;
			margin-top: 10px;
			width: 24px;
		}
		#containerId {
			position: relative;
		}
		.line {
			xosition: absolute;
		}

		:host /deep/ paper-dialog > *:last-child {
			margin-bottom: 4px;
		}
		:host /deep/ paper-dialog > *:first-child {
			margin-top: 14px;
		}
		:host /deep/ paper-dialog#searchDialog {
			padding: 0px 0px 0 0px;
		}
		:host /deep/ .button-content {
			padding: 0.2em 0.27em;
		}
		paper-button {
			min-width: 0px;
		}
		:host /deep/ #scrollable {
			max-height: inherit !important;
			padding: 0 10px;
		}
		:host /deep/ select-field.gridinput div.input-content.paper-input-container{
			max-height: 22px !important;
		}
		:host /deep/ select-field.gridinput label{
			padding-bottom: 0px !important;
		}
		:host /deep/ select-field.gridinput div.selectize-control{
			line-height: 15px !important;
		}

		:host /deep/ select-field.gridinput div.item{
			height: 16px;
			margin-top: 6px;
		}

		div.line {
			margin-bottom: 15px;
		}
		paper-icon-button /deep/ iron-icon{
			pointer-events: none;
		}

		@media screen and (max-width: 1200px) {
			div.line {
				margin-bottom: 20px;
    		border-top: 5px solid #BFCBD0;
			}
		}
		@media screen and (max-width: 1024px) {
			div.line {
				margin-bottom: 30px;
    		border-top: 5px solid #BFCBD0;
			}
		}
		@media screen and (max-width: 640px) {
			#searchDialog /deep/ #scrollable.scrollable {
				padding: 0px !important;
			}
		}

	</style>
  <style is="custom-style" include="simpl-crud-shared-styles"></style>
	<template>

		<div id="floatedLabel" hidden$="[[!label]]" class="floatedLabel">
			<label class="label-text">{{label}}</label>
			<paper-tooltip for="" position="bottom" xffset="0">[[help]]</paper-tooltip>
		</div>
		<div id="containerId" vertical layout style$="[[getContainerStyle(height)]]">

			<template is="dom-repeat" index-as="lid" as="line" items="[[lines]]">
				<div class="line grid row">
					<template is="dom-repeat" index-as="cid" as="col" items="[[columns]]">
						<grid-element-renderer id="[[getElementId(lid,cid)]]" data-lid$="[[lid]]" style$="[[getColStyle(col.width)]]" class$="[[getColFlex(col.width)]]" item="[[col]]"></grid-element-renderer>
					</template>
					<div>
						<template is="dom-if" if="[[search]]">
							<paper-icon-button on-tap="_search" data-lid$="[[lid]]" icon="search"></paper-icon-button>
						</template>
						<paper-icon-button on-tap="addLine" data-lid$="[[lid]]" icon="add"></paper-icon-button>
						<paper-icon-button on-tap="removeLine" data-lid$="[[lid]]" icon="remove"></paper-icon-button>
						<template is="dom-if" if="[[arrows]]">
							<paper-icon-button on-tap="upLine" data-lid$="[[lid]]" icon="expand-less"></paper-icon-button>
							<paper-icon-button on-tap="downLine" data-lid$="[[lid]]" icon="expand-more"></paper-icon-button>
						</template>
					</div>
				</div>
			</template>

			<div class="error layout horizontal center" hidden$="[[!isInvalid]]">
				<div class="error-text flex auto" role="alert" aria-hidden$="[[!isInvalid]]"></div>
				<div class="error-text" role="alert" aria-hidden$="[[!isInvalid]]">{{error}}<span>&nbsp;&nbsp;</span>
				</div>
				<iron-icon class="error-icon" icon="warning"></iron-icon>
			</div>
		</div>
		<paper-dialog id="searchDialog" no-cancel-on-outside-click with-backdrop="">
			<paper-dialog-scrollable>
				<div style="color:#d00c0c;">
					<simpl-filter id="filterId" style="margin-bottom:10px;" namespace="{{namespace}}" with-cancel on-cancel="cancelAction" entity="{{entityName}}" filter="{{filter}}"></simpl-filter>
					<div style="height:13px;padding-right:20px;line-height:initial;" class="layout horizontal"><div class="flex">&#160;</div><div class="" style="font-size:11px;">[[getHelp()]]</div></div>
					<simpl-panel bgcolor="black" heading="[[getHeader(entityName)]]">
						<simpl-crudtable id="linkedObjId" disable-spinner namespace="{{namespace}}" on-rows-selected="rowsSelected" meta="{{meta}}" filter="{{filter}}"></simpl-crudtable>
					</simpl-panel>
				</div>
			</paper-dialog-scrollable>
		</paper-dialog>
	</template>
	<script>
		Polymer( {
			is: "gridinput-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				TranslationsBehavior,
				DialogBehavior,
				FormBehavior,
				FieldBehavior
			],
			properties: {
				required: {
					value: "",
					type: String
				},
				columns: {
					value: null,
					observer: "columnsChanged",
					type: Array
				},
				lines: {
					value: function() {
						return [];
					},
					type: Array
				},
				entity: {
					type: String
				},
				search: {
					value: false,
					type: Boolean
				},
				arrows: {
					value: true,
					type: Boolean
				},
				height: {
					value: null,
					type: String
				}
			},
			listeners: {
				'value-changed': '_valueChanged',
				'internal-xaction': '_internalXAction'
			},
			observers: [
				'entityChanged(entity,namespace)'
			],
			ready: function() {
				this.isInvalid = false;
				this.push( "lines", {} );
			},
			clearLines:function(){
				this.splice("lines", 0, this.lines.length)
				this.push( "lines", {} );
				this.setDefaultValue(0);
			},
			_valueChanged: function(e) {
				var lid = e.target.parentNode.dataset.lid;
				var data = {};
				var fields = {};
				for ( var j = 0; j < this.columns.length; j++ ) {
					var e = this.querySelector( "#id" + lid + "_" + j );
					var col = this.columns[ j ];
					data[col.colname] = e.getValue(  );
					fields[col.colname] = e;
				}
				var keys = Object.keys(this.exprMap);
				keys.forEach( (function( key ){
					var expr = this.exprMap[key];
					var result = this.form._maskedEval( expr, data, "" );
//					console.log("Expr("+expr+"):",result);
					fields[key].setValue( result );
				}).bind(this));
			},
			getValue: function() {
				var value = [];
				for ( var i = 0; i < this.lines.length; i++ ) {
					var line = this.lines[ i ];
					value.push( this.getLineValues( i ) );
				}
				return value;
			},
			setValue: function( v ) {
				if ( !v ) {
					this.clearLines();
					this.async( function() {
						this.setLineValues( {}, 0 );
					}, 100 );
					return;
				}
				this.clearLines();
				this.async( function() {
					for ( var i = 1; i < v.length; i++ ) {
						this.push( "lines", {} );
					}
					this.async( function() {
						for ( var i = 0; i < v.length; i++ ) {
							var line = v[ i ];
							this.setLineValues( line, i );
						}
					}, 100 );
				}, 100 );
			},
			getContainerStyle: function() {
				return "border:0px solid #f5f5f5;padding:2px;min-height:" + this.height + "px";
			},
			getElementId: function( lid, cid ) {
				return "id" + lid + "_" + cid;
			},
			entityChanged: function() {
				this.async( function() {
					if( this.entity == null){
					  return;
					}
					var pack = this.getPack();
					this.entityName = pack ? (pack +":"+ this.getSimpleEntityName(this.entity)) : this.entity;
				},10 );
			},
			getHeader:function(entityName){
				this.pack = this.getPack() || "data";
				return tr(this.pack+'.'+this.getSimpleEntityName(entityName));
			},
			_search: function(e) {
				this._lid = parseInt(e.target.dataset.lid);
				this._entityName = this.entityName;
				this.$.filterId.doSearch();
				this.async( function() {
					this.openDialog( this.$.searchDialog );
				},250 );
			},
			rowsSelected: function( e ) {
				if( !e.detail.doubleTap ){
					return;
				}
				var data = e.detail.rows[0];
				this.closeDialog( this.$.searchDialog );
				console.log("data:", data);
				this.setLineValues( data, this._lid);
			},
			cancelAction: function() {
				this.async( function() {
					this.closeDialog( this.$.searchDialog );
				},50 );
			},
			getHelp:function(){
				return tr("crud2.select_with");
			},
			columnsChanged: function() {
				var exprMap = {};
				this.columns.each( ( function( c ) {
					c.regulaConstraints = this._constructRegulaConstraints( c.constraints, c.errormsg );
					c.label = c.display;
					if( c.id != "Enumselect"){
						c.id = "Input";
					}
					c.xf_type = c.type;
					c.xf_id = c.colname;
					if( c.parameter && c.parameter.startsWith("expr:")){
						exprMap[c.colname] =  c.parameter.substring(5);
					}
				} ).bind( this ) );
				this.exprMap = exprMap;
				//console.debug( "columnsChanged:", this.columns );
			},
			addLine: function( e ) {
				var lid = parseInt(e.target.dataset.lid);
				this.push( "lines", {} );
				this.async( function() {
					for ( var i = this.lines.length-1; (i-1) > lid; i-- ) {
						this._upLine(i);
					}
					this.setDefaultValue( this.lines.length-1);
				}, 20 );
			},
			removeLine: function( e ) {
				if ( this.lines.length > 1 ) {
					var lid = e.target.dataset.lid;
					var ret = this.splice( 'lines', lid, 1 );
				}
			},
			upLine: function( e ) {
				var lid = parseInt(e.target.dataset.lid);
				if ( lid == 0 || this.lines.length==1 ) {
					return;
				}
				this._upLine(lid);
			},
			_upLine: function( lid ) {
				var temp = this.getLineValues(lid-1);
				this.setLineValues( this.getLineValues(lid), lid-1);
				this.setLineValues( temp, lid);
			},
			downLine: function( e ) {
				var lid = parseInt(e.target.dataset.lid);
				if ( lid == (this.lines.length-1) || this.lines.length==1 ) {
					return;
				}
				var temp = this.getLineValues(lid+1);
				this.setLineValues( this.getLineValues(lid), lid+1);
				this.setLineValues( temp, lid);
			},

			setLineValues: function( line, i ) {
				for ( var j = 0; j < this.columns.length; j++ ) {
					var e = this.querySelector( "#id" + i + "_" + j );
					var col = this.columns[ j ];
					var name = col.colname;
					var val = line[ name ];
					e.getGridField().withoutCheck = true;
					if( val == null && col.xf_default){
						val = col.xf_default;
					}
					e.setValue( val );
				}
			},
			getLineValues: function( i ) {
				var line = {};
				for ( var j = 0; j < this.columns.length; j++ ) {
					var e = this.querySelector( "#id" + i + "_" + j );
					var val = e.getValue();
					var col = this.columns[ j ];
					line[ col.colname ] = val;
				}
				return line;
			},
			setDefaultValue: function( i ) {
				for ( var j = 0; j < this.columns.length; j++ ) {
					var e = this.querySelector( "#id" + i + "_" + j );
					var col = this.columns[ j ];
					var name = col.colname;
					var val = null;
					e.getGridField().withoutCheck = true;
					if( val == null && col.xf_default){
						val = col.xf_default;
					}
					e.setValue( val );
				}
			},
			checkConstraints: function() {
				this.setInvalid( false );
				for ( var i = 0; i < this.lines.length; i++ ) {
					this.validateLine(i);
				}
			},
			getColFlex:function(w){
				if( w != null && parseInt(w) > 0){
					return "";
				}
				return "flex";
			},
			getColStyle:function(w){
				if( w != null && parseInt(w) > 0){
					return "width:"+w+"px;min-width:"+w+"px;";
				}
				return "";
			},
			validateLine: function( i ) {
				var line = {};
				for ( var j = 0; j < this.columns.length; j++ ) {
					var e = this.querySelector( "#id" + i + "_" + j );
					var elements =e.getGridField();
					if( !elements.getAttribute("data-constraints")) continue;
					regula.bind( {
						elements: [elements]
					} );
					var errorList = regula.validate( {
						elements: [elements]
					} );
					//console.log("errorList:",errorList);
				}
			},
			setErrorMessage: function( message ) {
				this.error = message;
			},
			setInvalid: function( b ) {
				this.isInvalid = b;
			},
			isRequired: function() {
				var data = this.form._getData();
				var req = this.form._maskedEval( this.required, data, false );
				return req;
			}
		} );

	</script>
</dom-module>

<dom-module id="tableselect-field">
	<style>
		.error {
			color: #d34336;
		}
		.error-text {
			font-size: 0.75em;
			padding: 0.5em 0;
		}
		[invisible] {
			visibility: hidden;
		}
		.floatedLabel {
			font-size: 1.05em;
			white-space: nowrap;
			color: #757575;
			padding:0.4em;
		}
		.label-text {
			display: inline-block;
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		:host /deep/ .dataTables_wrapper.no-footer .dataTables_scrollBody {
			border-bottom: 0px solid #fc0;
		}
		simpl-datatables /deep/ #dataTablesId thead tr th,
		:host /deep/ #dataTablesId tfoot tr th {
			//background: white;
		}

	</style>
	<template>

			<div id="floatedLabel" hidden$="[[!label]]" class="floatedLabel">
				<label class="label-text">{{label}}</label>
				<paper-tooltip for="" position="bottom" xffset="0">[[help]]</paper-tooltip>
			</div>
			<div class="vertical layout" style="[[getHeight(height)]">
				<simpl-datatables style="width:100%;position:relative;" class="flex" id="dataTable" invalid$="[[isInvalid]]" selection="{{selection}}" multi-Select="[[multiSelect]]" selected="{{value}}" options="[[dataTablesOptions]]" meta="[[meta]]" data="[[items]]">
				</simpl-datatables>
				<div class="error layout horizontal center" hidden$="[[!isInvalid]]">
					<div class="error-text flex auto" role="alert" aria-hidden$="[[!isInvalid]]"></div>
					<div class="error-text" role="alert" aria-hidden$="[[!isInvalid]]">{{error}}<span>&nbsp;&nbsp;</span></div>
					<iron-icon class="error-icon" icon="warning"></iron-icon>
				</div>
			</div>
	</template>
	<script>
		Polymer( {
			is: "tableselect-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				TranslationsBehavior,
				FieldBehavior
			],
			properties: {
				multiSelect: {
					value:false,
					type: Boolean
				},
				required: {
					value:"",
					type: String
				},
				items: {
					observer: "itemsChanged",
					type: Object
				},
				selection: {
					type: Object,
					notify:true
				},
				meta: {
					type: Object
				},
				height: {
					value:null,
					observer: "heightChanged",
					type: String
				}
			},
			observers: [
				'selectionChanged(selection)'
			],
			getHeight:function(){
				return "height:"+this.height+"px";
			},
			checkConstraints: function() {
				this.setInvalid( false );
				if ( !this.isRequired() ) return;
				if ( this.selection && this.selection.length > 0 ) {
					return;
				}
				this.setInvalid( true );
				this.setErrorMessage( tr( "This field is required" ) );
			},
			setValue: function( v ) {
				this.$.dataTable.unselectAll();
				this.value = null;
			},
			getValue: function() {
				if( this.multiSelect ){
					return this.value;
				}else{
					if( Array.isArray(this.value) && this.value.length>0  ){
						return this.value[0];	
					}
				}
				return null;
			},
			setErrorMessage: function( message ) {
				this.error = message;
			},
			setInvalid: function( b ) {
				this.isInvalid = b;
			},
			selectionChanged: function() {
				this.value = this.selection;
				this.checkConstraints();
				this.fire( 'value-changed', this );
			},
			heightChanged: function() {
				this.dataTablesOptions = {
					paging: true,
					dom: "rt",
					scrollCollapse: false,
					scrollY: ( this.height - 40 ) + "px"
				};
				this.setInvalid(false);;
			},
			itemsChanged: function( items ) {
				//console.log("itemsChanged("+this._iid+"):",this.items);
			},
			setItems: function( items ) {
				this.items = items;
			},
			isRequired: function() {
				var data = this.form._getData();
				var req = this.form._maskedEval( this.required, data, false );
				return req;
			}
		} );

	</script>
</dom-module>

<dom-module id="linkedlist-field">
	<style>
		.error {
			color: #d34336;
		}
		.error-text {
			font-size: 0.75em;
			padding: 0.5em 0;
		}
		[invisible] {
			visibility: hidden;
		}
		.floatedLabel {
			font-size: 1.05em;
			white-space: nowrap;
			color: #757575;
			padding:0.4em;
		}
		.label-text {
			display: inline-block;
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		:host /deep/ .dataTables_wrapper.no-footer .dataTables_scrollBody {
			border-bottom: 0px solid #fc0;
		}
		simpl-datatables /deep/ #dataTablesId thead tr th,
		:host /deep/ #dataTablesId tfoot tr th {
			//background: white;
		}

	</style>
	<template>
		<div class="vertical layout">
			<simpl-linkedlist id="miniId" on-changed="onChanged" height="[[height]]" namespace="[[namespace]]" entity="[[entity]]"></simpl-linkedlist>
			<div class="error layout horizontal center" hidden$="[[!isInvalid]]">
				<div class="error-text flex auto" role="alert" aria-hidden$="[[!isInvalid]]"></div>
				<div class="error-text" role="alert" aria-hidden$="[[!isInvalid]]">{{error}}<span>&nbsp;&nbsp;</span></div>
				<iron-icon class="error-icon" icon="warning"></iron-icon>
			</div>
		</div>
	</template>
	<script>
		Polymer( {
			is: "linkedlist-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				TranslationsBehavior,
				FieldBehavior
			],
			properties: {
				required: {
					value:"",
					type: String
				},
				entity: {
					value:null,
					type: String
				},
				namespace: {
					value:null,
					type: String
				},
				meta: {
					type: Object
				},
				height: {
					value:null,
					observer: "heightChanged",
					type: String
				}
			},
			observers: [
				'entityChanged(entity,namespace)'
			],
			onChanged:function(e){
				console.log("onChanged:",e);
				this.value = e.detail.data;
			},
			entityChanged:function(){
			  console.log("Field.linkedlist-field.entityChanged:",this.entity+"/"+this.namespace);
				this.setInvalid( false );
			},
			checkConstraints: function() {
				this.setInvalid( false );
				if ( !this.isRequired() ) return;
				if ( this.value && this.value.length > 0 ) {
					return;
				}
				this.setInvalid( true );
				this.setErrorMessage( tr( "This field is required" ) );
			},
			setValue: function( v ) {
				this.value = v;
				this.querySelector( "#miniId" ).setData(v);
			},
			getValue: function() {
				return this.value;
			},
			setErrorMessage: function( message ) {
				this.error = message;
			},
			setInvalid: function( b ) {
				this.isInvalid = b;
			},
			heightChanged: function() {
				this.setInvalid(false);;
			},
			isRequired: function() {
				var data = this.form._getData();
				var req = this.form._maskedEval( this.required, data, false );
				return req;
			}
		} );

	</script>
</dom-module>

<dom-module id="embeddedlist-field">
	<style>
		.error {
			color: #d34336;
		}
		.error-text {
			font-size: 0.75em;
			padding: 0.5em 0;
		}
		[invisible] {
			visibility: hidden;
		}
		.floatedLabel {
			font-size: 1.05em;
			white-space: nowrap;
			color: #757575;
			padding:0.4em;
		}
		.label-text {
			display: inline-block;
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		:host /deep/ .dataTables_wrapper.no-footer .dataTables_scrollBody {
			border-bottom: 0px solid #fc0;
		}
		simpl-datatables /deep/ #dataTablesId thead tr th,
		:host /deep/ #dataTablesId tfoot tr th {
			//background: white;
		}

	</style>
	<template>
		<div class="vertical layout">
			<simpl-embeddedlist id="miniId" on-changed="onChanged" height="[[height]]" namespace="[[namespace]]" entity="[[entity]]"></simpl-embeddedlist>
			<div class="error layout horizontal center" hidden$="[[!isInvalid]]">
				<div class="error-text flex auto" role="alert" aria-hidden$="[[!isInvalid]]"></div>
				<div class="error-text" role="alert" aria-hidden$="[[!isInvalid]]">{{error}}<span>&nbsp;&nbsp;</span></div>
				<iron-icon class="error-icon" icon="warning"></iron-icon>
			</div>
		</div>
	</template>
	<script>
		Polymer( {
			is: "embeddedlist-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				TranslationsBehavior,
				FieldBehavior
			],
			properties: {
				required: {
					value:"",
					type: String
				},
				entity: {
					value:null,
					type: String
				},
				namespace: {
					value:null,
					type: String
				},
				meta: {
					type: Object
				},
				height: {
					value:null,
					observer: "heightChanged",
					type: String
				}
			},
			observers: [
				'entityChanged(entity,namespace)'
			],
			onChanged:function(e){
				console.log("onChanged:",e);
				this.value = e.detail.data;
			},
			entityChanged:function(){
			  console.log("Field.embeddedlist-field.entityChanged:",this.entity+"/"+this.namespace);
				this.setInvalid( false );
			},
			checkConstraints: function() {
				this.setInvalid( false );
				if ( !this.isRequired() ) return;
				if ( this.value && this.value.length > 0 ) {
					return;
				}
				this.setInvalid( true );
				this.setErrorMessage( tr( "This field is required" ) );
			},
			setValue: function( v ) {
				this.value = v;
				console.log("setValue("+this.entity+","+this.name+"):",this.value);
				this.querySelector( "#miniId" ).setData(v);
			},
			getValue: function() {
				console.log("getValue("+this.entity+","+this.name+"):",this.value);
				return this.value;
			},
			setErrorMessage: function( message ) {
				this.error = message;
			},
			setInvalid: function( b ) {
				this.isInvalid = b;
			},
			heightChanged: function() {
				this.setInvalid(false);;
			},
			isRequired: function() {
				var data = this.form._getData();
				var req = this.form._maskedEval( this.required, data, false );
				return req;
			}
		} );

	</script>
</dom-module>

<dom-module id="linkedobj-field">
	<style>
			:host {
				display:inherit;
			}
		:host {
			--paper-input-container: {
				padding: 0px;
			};
		}
		:host /deep/ paper-dialog > *:last-child {
			margin-bottom: 4px;
		}
		:host /deep/ paper-dialog > *:first-child {
			margin-top: 14px;
		}
		:host /deep/ paper-dialog#linkedObjDialog {
			padding: 0px 0px 0 0px;
		}
		:host /deep/ .button-content {
			padding: 0.2em 0.27em;
		}
		paper-button {
			min-width: 0px;
		}
		:host /deep/ #scrollable {
			max-height: inherit !important;
			padding: 0 10px;
		}
	</style>
  <style is="custom-style" include="simpl-crud-shared-styles"></style>
	<template>

		<div class="layout horizontal center">
		<paper-input-container id="decorator" class="flex" no-label-float="[[noLabelFloat]]" always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]" readonly disabled$="[[disabled]]">
			<label id="label" hidden$="[[!label]]">[[label]]</label>
			<paper-tooltip for="" position="bottom" xffset="0">[[help]]</paper-tooltip>
			<input is="iron-input" id="input" value="{{editValue}}" bind-value="[[editValue]]"  readonly disabled$={{disabled}}>
			</paper-input-container>
			<paper-button on-tap="actionCallback" class="button" raised>
				<iron-icon icon="launch"></iron-icon>
			</paper-button>
			<template is="dom-if" if="{{isMetaNull()}}">
				<paper-button on-tap="clearCallback" class="button" raised>
					<iron-icon icon="clear"></iron-icon>
				</paper-button>
			</template>
		</div>

		<paper-dialog id="linkedObjDialog" no-cancel-on-outside-click with-backdrop="">
			<paper-dialog-scrollable>
				<div style="color:#d00c0c;">
					<simpl-filter id="filterId" style="margin-bottom:10px;" namespace="{{namespace}}" with-cancel on-cancel="cancelAction" entity="{{entityName}}" filter="{{filter}}"></simpl-filter>
					<div style="height:13px;padding-right:20px;line-height:initial;" class="layout horizontal"><div class="flex">&#160;</div><div class="" style="font-size:11px;">[[getHelp()]]</div></div>
					<simpl-panel bgcolor="black" heading="[[getHeader(_entityName)]]">
						<simpl-crudtable id="linkedObjId" disable-spinner namespace="{{namespace}}" on-rows-selected="rowsSelected" meta="{{meta}}" filter="{{filter}}"></simpl-crudtable>
					</simpl-panel>
				</div>
			</paper-dialog-scrollable>
		</paper-dialog>

	</template>
	<script>
		Polymer( {
			is: "linkedobj-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				DialogBehavior,
				TranslationsBehavior,
				FieldBehavior
			],
			properties: {
				namespace: {
					type: String
				},
				entity: {
					type: String
				}
			},
			observers: [
				'editValueChanged(editValue)',
				'entityChanged(entity,namespace)'
			],
			id: null,
			isMetaNull: function() {
				return this.meta == null;
			},
			isFilter: function( filter ) {
				return this.filter != null;
			},
			ready: function() {
				console.log("Field.linkedobj.ready:",this.entity+"/"+this.namespace);
				this.props = simpl4.util.EntityManager.getPropertiesForEntity( this.entity, {
					namespace: this.namespace
				} );
			},
			actionCallback: function() {
				this._entityName = this.entityName;
				this.$.filterId.doSearch();
				this.async( function() {
					this.openDialog( this.$.linkedObjDialog );
				},250 );
			},
			clearCallback: function() {
				this.editValue = null;
				this.id = null;
			},
			rowsSelected: function( e ) {
				if( !e.detail.doubleTap ){
					return;
				}
				this.data = e.detail.rows[0];
				this.closeDialog( this.$.linkedObjDialog );
				var t = this._maskedEval( this.props.title_expression, this.data );
				this.id = this.data.id || this.data._id;
				this.editValue = t || this.id ||  ".";
			},
			cancelAction: function() {
				this.async( function() {
					this.closeDialog( this.$.linkedObjDialog );
				},50 );
			},
			editValueChanged: function() {
				if ( this.editValue ) {
					if( "odata" == this.getPack()){
						this.value = this.data;
					}else{
						this.value = this.editValue + "/" + this.id;
					}
				} else {
					this.value = null;
				}
				console.log("editValueChanged("+this.getPack()+","+this.entityName+","+this.name+"):",this.value);
				this.fire( 'value-changed', this );
			},
			getValue: function( v ) {
				console.log("getValue("+this.entityName+","+this.name+"):",this.value);
				return this.value;
			},
			setValue: function( v ) {
				console.log("setValue("+this.entityName+","+this.name+"):",v);
				if ( v != null ) {
					if( _.isString(v)){
						var s = v.split( "/" );
						this.editValue = s[ 0 ];
						this.id = s[ 1 ];
					}else{
						this.data = v;
						var t = this._maskedEval( this.props.title_expression, this.data );
						this.editValue = t || this.data._id || this.data.id| ".";
					}
				} else {
					this.editValue = null;
				}
			},
			namespaceChanged: function() {
				simpl4.util.MessageManager.installMessages( this.namespace );
			},
			entityChanged: function() {
				this.async( function() {
					if( this.entity == null){
					  return;
					}
					var pack = this.getPack();
					this.entityName = pack ? (pack +":"+ this.getSimpleEntityName(this.entity)) : this.entity;
				},10 );
			},
			getHelp:function(){
				return tr("crud2.select_with");
			},
			getHeader:function(entityName){
				this.pack = this.getPack() || "data";
				return tr(this.pack+'.'+this.getSimpleEntityName(entityName));
			},
			_maskedEval: function( scr, env, def ) {
				try {
					return ( new Function( "with(this) { return " + scr + "}" ) ).call( env );
				} catch ( e ) {
					console.log( "LinkedObjFieldField._maskedEval:" + scr );
					console.error( "error:" + e );
				}
				return def;
			}
		} );

	</script>
</dom-module>


<dom-module id="embeddedobj-field">
	<style>
		:host /deep/ #embeddedObjDialog {
			position:fixed;
			top: 5vh;
			min-width: 70%;
			max-width: 70%;
			max-height:90%;
			border-radius: 4px;
		}
		@media screen and (max-width: 767px) {
			:host /deep/ #embeddedObjDialog {
				left: 0vw;
				min-width: 100%;
				margin: 0px;
			}
		}
		#embeddedObjDialog {
			margin: 0px;
			padding: 0px;
		}
		:host {
			--paper-input-container: {
				padding: 0px;
			};
		}
		:host /deep/ paper-dialog > *:last-child {
			margin-bottom: 4px;
		}
		:host /deep/ paper-dialog > *:first-child {
			margin-top: 14px;
		}
		:host /deep/ paper-dialog#embeddedObjDialog {
			padding: 0px 0px 0 0px;
		}
		:host /deep/ .button-content {
			padding: 0.2em 0.27em;
		}
		paper-button {
			min-width: 0px;
		}
		:host /deep/ #scrollable {
			max-height: inherit !important;
			padding: 0 10px;
		}

	</style>
	<template>

		<div class="layout horizontal center">
		<paper-input-container id="decorator" class="flex" no-label-float="[[noLabelFloat]]" always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]" readonly disabled$="[[disabled]]">
			<label id="label" hidden$="[[!label]]">[[label]]</label>
			<paper-tooltip for="" position="bottom" xffset="0">[[help]]</paper-tooltip>
			<input is="iron-input" id="input" value="{{editValue}}" bind-value="[[editValue]]"  readonly disabled$={{disabled}}>
			</paper-input-container>
			<paper-button on-tap="actionCallback" class="button" raised>
				<iron-icon icon="launch"></iron-icon>
			</paper-button>
			<paper-button on-tap="clearCallback" class="button" raised>
				<iron-icon icon="clear"></iron-icon>
			</paper-button>
		</div>

		<paper-dialog id="embeddedObjDialog" no-cancel-on-outside-click with-backdrop="">
			<paper-dialog-scrollable>
					<paper-button class="button button_secondary ripple flex" raised name$="{{buttonsave.name}}" on-tap="takeOverAction" disabled$="{{buttonsave.disabled}}">
						<iron-icon name$="{{buttonsave.name}}" icon="{{buttonsave.icon}}"></iron-icon>{{buttonsave.text}}</paper-button>
					<paper-button class="button button_secondary ripple flex" raised name$="{{buttoncancel.name}}" on-tap="cancelAction" disabled$="{{buttoncancel.disabled}}">
						<iron-icon name$="{{buttoncancel.name}}" icon="{{buttoncancel.icon}}"></iron-icon>{{buttoncancel.text}}</paper-button>
				<simpl-form id="formid" mode="{{mode}}" pack="[[_pack]]" variables="{{variables}}" namespace="{{namespace}}" form-name="[[formName]]" save-disabled="{{saveDisabled}}" spec="{{formSpec}}"></simpl-form>
			</paper-dialog-scrollable>
		</paper-dialog>

	</template>
	<script>
		Polymer( {
			is: "embeddedobj-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				DialogBehavior,
				TranslationsBehavior,
				FieldBehavior
			],
			properties: {
				namespace: {
					type: String
				},
				entity: {
					type: String
				}
			},
			observers: [
				'editValueChanged(editValue)',
				'entityChanged(entity,namespace)'
			],
			id: null,
			ready: function() {
				this.props = simpl4.util.EntityManager.getPropertiesForEntity( this.entity, {
					namespace: this.namespace
				} );
				this.buttonsave= {
					icon: "undo",
					position: "form",
					text: tr( 'button.take_over' ),
					disabled: false
				};
				this.buttoncancel= {
					icon: "cancel",
					position: "form",
					text: tr( 'button.cancel' ),
					disabled: false
				}
			},
			setFormSpec: function( namespace, entity ) {
				var formSpec = simpl4FormManager.getCrudForm( entity, namespace );
				console.log("setFormSpec("+this.name+"):",formSpec);
				if ( typeof formSpec === 'string' ) {
					this.formName = formSpec;
				} else {
					this.formSpec = [ formSpec ];
				}
			},
			actionCallback: function() {
				this._pack = this.getPack();
				this.$.formid.setData(this.data);
				this.async( function() {
					this.openDialog( this.$.embeddedObjDialog );
				},50 );
			},
			clearCallback: function() {
				this.editValue = null;
				this.id = null;
			},
			takeOverAction: function( e ) {
				this.data = this.$.formid.getData();
				this.closeDialog( this.$.embeddedObjDialog );
				var t = this._maskedEval( this.props.title_expression, this.data );
				this.editValue = t || this.data._id ||  ".";
			},
			cancelAction: function() {
				this.async( function() {
					this.closeDialog( this.$.embeddedObjDialog );
				},50 );
			},
			editValueChanged: function() {
				if ( this.editValue ) {
					this.value = this.data;
				} else {
					this.value = null;
				}
				console.log("editValueChanged("+this.name+"):",this.value);
				this.fire( 'value-changed', this );
			},
			setValue: function( v ) {
				console.log("setValue("+this.name+"):",v);
				if ( v != null ) {
					this.data = v;
					var t = this._maskedEval( this.props.title_expression, this.data );
					this.editValue = t || this.data._id ||  ".";
				} else {
					this.editValue = null;
				}
			},
			namespaceChanged: function() {
				simpl4.util.MessageManager.installMessages( this.namespace );
			},
			entityChanged: function() {
				console.log("entityChanged("+this.name+"):",this.entity);
				this.async( function() {
					if( this.entity == null){
					  return;
					}
					this.setFormSpec( this.namespace, this.entity );
				},10 );
			},
			_maskedEval: function( scr, env, def ) {
				try {
					return ( new Function( "with(this) { return " + scr + "}" ) ).call( env );
				} catch ( e ) {
					console.log( "EmbeddedObjFieldField._maskedEval:" + scr );
					console.error( "error:" + e );
				}
				return def;
			}
		} );

	</script>
</dom-module>

<dom-module id="embeddedobj-inline-field">
	<style>
		:host {
			--paper-input-container: {
				padding: 0px;
			};
		}
		#formid {
			position:relative;
			width:100%;
		}

	</style>
	<template>
		<div class="layout horizontal center">
			<simpl-form id="formid" mode="{{mode}}" pack="[[_pack]]" variables="{{variables}}" namespace="{{namespace}}" form-name="[[formName]]" save-disabled="{{saveDisabled}}" spec="{{formSpec}}"></simpl-form>
	</template>
	<script>
		Polymer( {
			is: "embeddedobj-inline-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				TranslationsBehavior,
				FieldBehavior
			],
			properties: {
				namespace: {
					type: String
				},
				entity: {
					type: String
				}
			},
			observers: [
				'entityChanged(entity,namespace)'
			],
			setFormSpec: function( namespace, entity ) {
				var formSpec = simpl4FormManager.getCrudForm( entity, namespace );
				console.log("setFormSpec("+this.name+"):",formSpec);
				if ( typeof formSpec === 'string' ) {
					this.formName = formSpec;
				} else {
					this.formSpec = [ formSpec ];
				}
			},
			checkConstraints: function() {
				var valid = this.$.formid.validate();
				this.setInvalid( !valid );
			},
			setInvalid: function( b ) {
				this.isInvalid = b;
			},
			getValue: function( v ) {
				var val=null;
				try{
					val = 	this.$.formid.getData();
				}catch(e){
					return null;
				}
				console.log("getValue("+this.name+"):",val);
				return val;
			},
			setValue: function( v ) {
				console.log("setValue("+this.name+"):",v);
				if ( v != null ) {
					this.$.formid.setData(v);
				}else{
					this.$.formid.setData({});
				}
			},
			namespaceChanged: function() {
				simpl4.util.MessageManager.installMessages( this.namespace );
			},
			entityChanged: function() {
				console.log("entityChanged("+this.name+"):",this.entity);
				this.async( function() {
					if( this.entity == null){
					  return;
					}
					this.setFormSpec( this.namespace, this.entity );
					this._pack = this.getPack();
				},10 );
			},
			_maskedEval: function( scr, env, def ) {
				try {
					return ( new Function( "with(this) { return " + scr + "}" ) ).call( env );
				} catch ( e ) {
					console.log( "EmbeddedObjFieldField._maskedEval:" + scr );
					console.error( "error:" + e );
				}
				return def;
			}
		} );

	</script>
</dom-module>
<!-- ---------------------------------------------------------------- -->
<dom-module id="db-selector-field">
	<style>
		:host /deep/ #selectorDialog {
			position:fixed;
			top: 5vh;
			min-width: 70%;
			max-width: 70%;
			max-height:90%;
			border-radius: 4px;
		}
		@media screen and (max-width: 767px) {
			:host /deep/ #selectorDialog {
				left: 0vw;
				min-width: 100%;
				margin: 0px;
			}
		}
		:host {
			--paper-input-container: {
				padding: 0px;
			};
		}
		:host /deep/ paper-dialog > *:last-child {
			margin-bottom: 4px;
		}
		:host /deep/ paper-dialog > *:first-child {
			margin-top: 14px;
		}
		:host /deep/ paper-dialog#selectorDialog {
			padding: 0px 0px 0 0px;
		}
		:host /deep/ .button-content {
			padding: 0.2em 0.27em;
		}
		paper-button {
			min-width: 0px;
		}
		:host /deep/ #scrollable {
			max-height: inherit !important;
			padding: 0 10px;
		}

	</style>
	<template>

		<div class="layout horizontal center">
		<paper-input-container id="decorator" class="flex" no-label-float="[[noLabelFloat]]" always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]" readonly disabled$="[[disabled]]">
			<label id="label" hidden$="[[!label]]">[[label]]</label>
			<paper-tooltip for="" position="bottom" xffset="0">[[help]]</paper-tooltip>
			<input is="iron-input" id="input" value="{{editValue}}" bind-value="[[editValue]]"  readonly disabled$={{disabled}}>
			</paper-input-container>
			<paper-button on-tap="actionCallback" class="button" raised>
				<iron-icon icon="launch"></iron-icon>
			</paper-button>
			<template is="dom-if" if="{{isMetaNull()}}">
				<paper-button on-tap="clearCallback" class="button" raised>
					<iron-icon icon="clear"></iron-icon>
				</paper-button>
			</template>
		</div>

		<paper-dialog id="selectorDialog" no-cancel-on-outside-click with-backdrop="">
			<paper-dialog-scrollable>
				<div class="lyaout vertical flex">
					<simpl-filter style="margin-bottom:10px;" namespace="{{namespace}}" entity="{{entityName}}" filter="{{filter}}"></simpl-filter>
					<div style="height:20px;"></div>
					<simpl-panel bgcolor="black" heading="[[getHeader(entityName)]]" collapsable="">
						<simpl-crudtable namespace="{{namespace}}" buttons="select,cancel" on-select-action="selectAction" on-cancel-action="cancelAction" meta="{{meta}}" filter="{{filter}}"></simpl-crudtable>
					</simpl-panel>
				</div>
			</paper-dialog-scrollable>
		</paper-dialog>

	</template>
	<script>
		Polymer( {
			is: "db-selector-field",
			behaviors: [
				Polymer.IronFormElementBehavior,
				Polymer.PaperInputBehavior,
				Polymer.IronControlState,
				TranslationsBehavior,
				FieldBehavior
			],
			properties: {
				namespace: {
					type: String
				},
				entity: {
					type: String
				}
			},
			observers: [
				'editValueChanged(editValue)',
				'entityChanged(entity,namespace)'
			],
			id: null,
			isMetaNull: function() {
				return this.meta == null;
			},
			isFilter: function( filter ) {
				return this.filter != null;
			},
			ready: function() {
				//console.log("Field.dbselector.ready:",this.entity+"/"+this.namespace);
				this.props = simpl4.util.EntityManager.getPropertiesForEntity( this.entity, {
					namespace: this.namespace
				} );
			},
			actionCallback: function() {
				this.async( function() {
					this.$.selectorDialog.open();
				},50 );
			},
			clearCallback: function() {
				this.editValue = null;
				this.id = null;
			},
			selectAction: function( e ) {
				var data = e.detail.data;
				this.$.selectorDialog.close();
				this.assignValues( data );
			},
			assignValues: function( record ) {
				var items = JSON.parse( this.fieldlist ).items;
				for ( var i = 0; i < items.length; i++ ) {
					var item = items[ i ];
					var path = item.path + "." + item.id;
					var value = record[ path ];
					if( value == null){
						path = item.id;
						value = record[ path ];
					}
					if ( value == undefined ) value = null;
					var form_fieldname = item.form_fieldname ? item.form_fieldname : item.db_fieldname;
					//console.debug( "db-selector-field.assignValue(" + path + "):" + form_fieldname + "=" + value );
					try {
						var f = this.form._getField( form_fieldname );
						if ( f == null ) {
							console.error( "db-selector-field.assignValue:field:" + form_fieldname + " not found" );
							continue;
						}
						f.setValue( value );
					} catch ( e ) {
						console.error( "db-selector-field.Cannot set value:" + e + "/" + e.stack );
					}
				}
			},
			getFieldDesc: function( entity, id ) {
				var colModel = this.fieldmap[ entity ];
				if ( colModel == null ) {
					this.getSelectableFields( entity );
					colModel = this.fieldmap[ entity ];
				}
				for ( var f = 0; f < colModel.length; f++ ) {
					var field = colModel[ f ];
					if ( field.hidden ) continue;
					if ( field.id == id ) {
						return field;
					}
				}
				return null;
			},
			getSelectableFields: function( entity ) {
				var colModel = this.fieldmap[ entity ];
				if ( colModel === undefined ) {
					try {
						var em = simpl4.util.EntityManager;
						var data = em.getEntityViewFields( entity, this.namespace, "report", false );
						colModel = em.buildColModel( data, this.namespace, entity, "search" );
						this.fieldmap[ entity ] = colModel;
					} catch ( e ) {
						console.error( "db-selector-field.getSelectableFields:" + e.stack );
						return;
					}
				}
				return colModel;
			},
			fieldlistChanged: function() {
				simpl4.util.MessageManager.installMessages( this.namespace );
				this.fieldmap = {};
				var columns = new Array();
				var displayColumns = new Array();
				var aliasColumns = new Array();
				var selFields = JSON.parse( this.fieldlist ).items;
				for ( var f = 0; f < selFields.length; f++ ) {
					var selField = selFields[ f ];

					if ( selField.display === true ) {
						var fieldDesc = this.getFieldDesc( selField.module, selField.id );
						if ( fieldDesc == null ) {
							console.error( "db-selector-field.fieldlistChanged:field(\"" + selField.id + "\") not found in \"" + selField.module + "\"" );
							return null;
						}
						var dt = fieldDesc[ "datatype" ];
						if ( dt && dt.match( "^array" ) ) {
							continue;
						}
						var fd = simpl4.util.Merge.deepmerge( {}, fieldDesc );
						fd.fqn = selField.path + "." + selField.id;
						fd.label = tr( "data." + simpl4.util.Inflector.getEntityName( selField.module ) ) + "/" + tr( "data." + selField.module + "." + selField.id );
						fd.title = fd.label;
						displayColumns.push( fd.fqn );
						aliasColumns.push( selField.mapping );
						fd[ "id" ] = fd.fqn;
						fd[ "name" ] = fd.fqn;
						columns.push( fd );
					}
				}
				this.meta = columns;
			},
			cancelAction: function() {
				this.async( function() {
					this.$.selectorDialog.close();
				},50 );
			},
			editValueChanged: function() {
				if ( this.editValue ) {
					this.value = this.editValue + "/" + this.id;
				} else {
					this.value = null;
				}
				this.fire( 'value-changed', this );
			},
			setValue: function( v ) {
				if ( v != null ) {
					var s = v.split( "/" );
					this.editValue = s[ 0 ];
					this.id = s[ 1 ];
				} else {
					this.editValue = null;
				}
			},
			namespaceChanged: function() {
				simpl4.util.MessageManager.installMessages( this.namespace );
			},
			entityChanged: function() {
				this.async( function() {
					console.log("Field("+this.name+"):entityChanged:"+this.getPack() + "/"+ this.getSimpleEntityName(this.entity)+"/"+this.namespace);
					if( this.entity==null) return;
					var pack = this.getPack();
					this.entityName = pack ? (pack +":"+ this.getSimpleEntityName(this.entity)) : this.entity;
				},10 );
			},
			getHeader:function(entityName){
				var pack = this.getPack() || "data";
				return tr(pack+'.'+this.getSimpleEntityName(entityName));
			},
			_maskedEval: function( scr, env, def ) {
				try {
					return ( new Function( "with(this) { return " + scr + "}" ) ).call( env );
				} catch ( e ) {
					console.log( "DbSelectorField._maskedEval:" + scr );
					console.error( "error:" + e );
				}
				return def;
			}
		} );

	</script>
</dom-module>

